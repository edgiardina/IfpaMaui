<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Ifpa.Converters"
             xmlns:controls="clr-namespace:Ifpa.Controls"
             x:Class="Ifpa.Views.RankingsPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:local="clr-namespace:Ifpa"
             x:Name="BrowseItemsPage"
             xmlns:vm="clr-namespace:Ifpa.ViewModels"
             x:DataType="vm:RankingsViewModel"
             xmlns:datatemplates="clr-namespace:Ifpa.Views.DataTemplates.Ranking"
             xmlns:ifpaplayers="clr-namespace:PinballApi.Models.WPPR.Universal.Players;assembly=PinballApi">
    
    <Shell.TitleView>
        <Grid>
            <!-- Normal title view with buttons -->
            <Grid IsVisible="{Binding IsSearchMode, Converter={StaticResource invertedBoolConverter}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <Label Grid.Column="0"
                       Text="{x:Static local:Strings.RankingsPage_Title}"
                       FontSize="24"
                       VerticalOptions="Center"
                       HorizontalOptions="Start" />
                
                <Label Grid.Column="1"
                       Text="{StaticResource FluentIcon.Search48}"
                       FontFamily="FluentRegular"
                       FontSize="28"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       TextColor="{StaticResource IconAccentColor}"
                       Padding="10,10">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ShowPlayerSearchCommand}" />
                    </Label.GestureRecognizers>
                </Label>
                
                <Label Grid.Column="2"
                       Text="{StaticResource FluentIcon.Filter28}"
                       FontFamily="FluentRegular"
                       FontSize="28"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       TextColor="{StaticResource IconAccentColor}"
                       Padding="10,10">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ShowRankingFilterCommand}" />
                    </Label.GestureRecognizers>
                </Label>
            </Grid>
            
            <!-- Search view -->
            <Grid IsVisible="{Binding IsSearchMode}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <SearchBar Grid.Column="0"
                           Text="{Binding SearchText, Mode=TwoWay}"
                           Placeholder="Search for players..."
                           IsSpellCheckEnabled="False"
                           IsTextPredictionEnabled="False"
                           BackgroundColor="Transparent" />
                <Button Grid.Column="1"
                        Text="Cancel"
                        Command="{Binding CancelSearchCommand}"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource IconAccentColor}"
                        FontSize="16"
                        Margin="5,0" />
            </Grid>
        </Grid>
    </Shell.TitleView>

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:InvertedBoolConverter x:Key="invertedBoolConverter" />
            <converters:AddressFormatConverter x:Key="AddressFormatConverter" />
            <datatemplates:ProRankingDataTemplate x:Key="ProRankingDataTemplate" />
            <datatemplates:RankingDataTemplate x:Key="RankingDataTemplate" />
            <datatemplates:PlayerSearchDataTemplate x:Key="PlayerSearchDataTemplate" />
            <datatemplates:RankingResultDataTemplateSelector x:Key="RankingResultDataTemplateSelector"                                                             
                                                             ProRankingTemplate="{StaticResource ProRankingDataTemplate}"
                                                             RankingResultTemplate="{StaticResource RankingDataTemplate}"
                                                             PlayerSearchTemplate="{StaticResource PlayerSearchDataTemplate}" />
        </ResourceDictionary>
    </ContentPage.Resources>
    
    <Grid>
        <ActivityIndicator IsVisible="{Binding IsBusy}"
                           IsRunning="{Binding IsBusy}" />
        
        <!-- Single CollectionView for both rankings and search results -->
        <CollectionView x:Name="PlayersListView"
                        ItemsSource="{Binding DisplayItems}"
                        IsVisible="{Binding IsBusy, Converter={StaticResource invertedBoolConverter}}"
                        SelectionMode="Single"
                        EmptyView="{Binding EmptyViewText}"
                        SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                        SelectionChangedCommand="{Binding ItemSelectedCommand}"
                        ItemTemplate="{StaticResource RankingResultDataTemplateSelector}" />
    </Grid>
</ContentPage>